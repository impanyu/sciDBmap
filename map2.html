<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Heatmaps</title>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        width: 90%;
        height: 90%;
        margin: 5% auto;
        padding: 0;
      }
      #floating-panel {
        position: absolute;
        top: 10px;
        left: 30%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
        padding-left: 10px;
      }
      #floating-panel {
        background-color: #fff;
        border: 1px solid #999;
        left: 25%;
        padding: 5px;
        position: absolute;
        top: 10px;
        z-index: 5;
      }
      #timeseries{
        height:50%;
        background-color: blue;
      }
    </style>
  </head>

  <body>
    <div id="floating-panel">
      <button onclick="toggleHeatmap()">Toggle Heatmap</button>
      <button onclick="changeGradient()">Change gradient</button>
      <button onclick="changeRadius()">Change radius</button>
      <button onclick="changeOpacity()">Change opacity</button>
      <button onclick="play()">Play</button>
      <button onclick="pause()">Pause</button>
      <button onclick="stop()">Stop</button>
    </div>
    <div id="map"></div>
    <div id="timeseries"></div>
    <div id="demo"></div>
    <script>
      // This example requires the Visualization library. Include the libraries=visualization
      // parameter when you first load the API. For example:
      // <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=visualization">
     var map, heatmap,heatmapData,animation,heatmapDataOrigin,playing=false,origin=true;
     var values; 
     var tmp=0;
     var timeframe=0;
      function play(){
           if(playing)
             return;
           playing=true;
           function animate(){
                queryData(timeframe);
                timeframe=timeframe+10;
                console.log("updated");
                heatmap.setData(heatmapData);
              animation=setTimeout(animate, 1000);
           }
           
           animation=setTimeout(animate, 1000);
      }
      function pause(){
          playing=false;
         clearTimeout(animation);
      }
      function stop(){
         clearTimeout(animation);
         playing=false;
        // heatmap.setData(heatmapDataOrigin);
       // heatmapData= jQuery.extend(true, [], heatmapDataOrigin);
         timeframe=0;
         queryData(timeframe);
  }


     function queryData(t){

           var xhttp1 = new XMLHttpRequest();
          xhttp1.onreadystatechange = function() {
         if (this.readyState == 4 && this.status == 200) {
       // Typical action to be performed when the document is ready:
                tmp=xhttp1.responseText;
                xhttp2 = new XMLHttpRequest();
          xhttp2.onreadystatechange = function() {
         if (this.readyState == 4 && this.status == 200) {
       // Typical action to be performed when the document is ready:
               var xhttp3 = new XMLHttpRequest();
               xhttp3.onreadystatechange=function() {
                  if(this.readyState == 4 && this.status == 200) {
                         values= xhttp3.responseText;
                         values=values.split(/,| |\n/); 
                       //  document.getElementById("demo").innerHTML += values;
                         heatmapData=[];
                         for(var i=1;i<values.length/3-1;i++){
                           var x= parseFloat(values[3*i].substring(1));
                           var y= parseFloat(values[3*i+1].substring(0,values[3*i+1].length-1));
                           var value= parseFloat(values[3*i+2]);
                           if(value>=0)
                              {
                                 x=(x-3500)/3500*180;
                                 y=(y-1750)/1750*90;
                                 heatmapData.push({location:new google.maps.LatLng(y,x),weight:parseFloat(value)});  
                              } 
                         
                          }
                         heatmap.setData(heatmapData);                 
                         xhttp4 = new XMLHttpRequest();
                         xhttp4.onreadystatechange= function(){
                            if(this.readyState == 4 && this.status==200){
                                    console.info("session closed");
                                  }

                             };
                       xhttp4.open("GET", "http://jaguar.unl.edu:8080/release_session?id="+tmp, true);
                       xhttp4.send();

                   } 
 
               };
  
                         xhttp3.open("GET", "http://jaguar.unl.edu:8080/read_lines?id="+tmp+"&n=1000000", true);
                         xhttp3.send();

     }
         };
            

                xhttp2.open("GET", "http://jaguar.unl.edu:8080/execute_query?id="+tmp+encodeURI("&query=filter(slice(NMQ_PRECIP,z,0,t,"+t+"),x%50=0 and y%50=0)&save=dcsv"), true);

                xhttp2.send();
 


            }
         };
          xhttp1.open("GET", "http://jaguar.unl.edu:8080/new_session", true);
          xhttp1.send();

         
 

     }
    
      function initMap() {
          heatmapData=[];


           heatmapDataOrigin = jQuery.extend(true, [], heatmapData);
          map = new google.maps.Map(document.getElementById('map'), {
          zoom: 1,
          center: {lat: 37.775, lng: -122.434},
          mapTypeId: 'satellite'
        });
          heatmap = new google.maps.visualization.HeatmapLayer({
                         data: [],
                         map: map
                       });
            queryData(0);

             }
      function toggleHeatmap() {
        heatmap.setMap(heatmap.getMap() ? null : map);
      }
      function changeGradient() {
        var gradient = [
          'rgba(0, 255, 255, 0)',
          'rgba(0, 255, 255, 1)',
          'rgba(0, 191, 255, 1)',
          'rgba(0, 127, 255, 1)',
          'rgba(0, 63, 255, 1)',
          'rgba(0, 0, 255, 1)',
          'rgba(0, 0, 223, 1)',
          'rgba(0, 0, 191, 1)',
          'rgba(0, 0, 159, 1)',
          'rgba(0, 0, 127, 1)',
          'rgba(63, 0, 91, 1)',
          'rgba(127, 0, 63, 1)',
          'rgba(191, 0, 31, 1)',
          'rgba(255, 0, 0, 1)'
        ]
        heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
      }
      function changeRadius() {
        heatmap.set('radius', heatmap.get('radius') ? null : 30);
      }
      function changeOpacity() {
        heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
      }
      // Heatmap data: 500 Points
      
        
      
        function getPoints() {
          return heatmapData;
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBU1RvtD5YF8-dwMmCIYP8ds-6Np5QVHFY&libraries=visualization&callback=initMap">
    </script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    
  </body>
</html>
